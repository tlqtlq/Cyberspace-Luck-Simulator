<script>
    let rolls = 0, hits = 0;
    const ODDS = 10000000;
    let flickerInterval = null, autoRollInterval = null, isAutoRolling = false, isCinematicPlaying = false, isCinematicEnabled = true, unlocked = false, isShowingIllusionary = false;
    let sfxVolume = 0.5, bgmVolume = 0.5;
    let logEntries = [];

    // User authentication state
    let currentUser = null;
    let isLoggedIn = false;
    let isCreateAccountMode = true; // Tracks whether we're in create account or login mode

    // Leaderboard data
    let leaderboardData = [];

    const illusionarySFX = new Audio('https://pomf2.lain.la/f/vvei5e1c.mov');
    const bgm = new Audio('https://pomf2.lain.la/f/jfj7608j.ogg');
    const video = document.getElementById('cinematic-video');
    const cinematicOverlay = document.getElementById('cinematic-overlay');
    const rollLog = document.getElementById('roll-log');

    illusionarySFX.preload = 'auto'; bgm.preload = 'auto'; bgm.loop = true;

    // ============================================
    // PROFANITY FILTER
    // ============================================

    // List of profane words to filter (can be expanded)
    const profanityFilter = [
        // Common profanity
        'fuck', 'shit', 'asshole', 'bitch', 'cunt', 'dick', 'pussy',
        'cock', 'whore', 'slut', 'bastard', 'damn', 'hell',
        
        // Variations and common misspellings
        'fck', 'sh1t', 'sh!t', 'f*ck', 'f**k', 'a$$', 'b!tch', 'b1tch',
        'c*nt', 'd!ck', 'd1ck', 'p*ssy', 'c*ck', 'wh*re', 'sl*t',
        
        // Racial slurs and hate speech
        'nigger', 'nigga', 'fag', 'faggot', 'retard', 'spic', 'chink',
        'kike', 'gook', 'wetback',
        
        // Additional offensive terms
        'rape', 'rapist', 'pedo', 'nazi', 'kkk'
    ];

    // Function to check for profanity
    function containsProfanity(text) {
        if (!text) return false;
        
        const lowerText = text.toLowerCase();
        
        // Check for exact matches
        for (const word of profanityFilter) {
            if (lowerText.includes(word)) {
                return true;
            }
        }
        
        // Check for leetspeak variations (e.g., @ for a, 3 for e, etc.)
        const leetVariations = {
            'a': ['@', '4'],
            'e': ['3'],
            'i': ['1', '!'],
            'o': ['0'],
            's': ['5', '$'],
            't': ['7']
        };
        
        // Create regex patterns for leetspeak variations
        for (const word of profanityFilter) {
            let pattern = word;
            
            // Replace characters with their leetspeak equivalents
            for (const [char, replacements] of Object.entries(leetVariations)) {
                for (const replacement of replacements) {
                    pattern = pattern.replace(new RegExp(char, 'g'), `[${char}${replacement}]`);
                }
            }
            
            // Check if pattern matches
            const regex = new RegExp(pattern, 'i');
            if (regex.test(text)) {
                return true;
            }
        }
        
        return false;
    }

    // Function to sanitize username
    function sanitizeUsername(username) {
        // Remove special characters except basic punctuation
        return username.replace(/[^a-zA-Z0-9\s\-_\.]/g, '');
    }

    // ============================================
    // ACCOUNT SYSTEM FUNCTIONS
    // ============================================

    // Show/hide account modal
    function toggleAccountMenu() {
        if (isLoggedIn) {
            // If logged in, log out
            logout();
        } else {
            // If not logged in, show account modal
            showAccountModal();
        }
    }

    function showAccountModal() {
        resetAccountForm();
        document.getElementById('account-modal').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('account-modal').style.opacity = '1';
        }, 10);
    }

    function hideAccountModal() {
        document.getElementById('account-modal').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('account-modal').style.display = 'none';
        }, 500);
    }

    function resetAccountForm() {
        document.getElementById('account-username').value = '';
        document.getElementById('account-password').value = '';
        document.getElementById('account-confirm-password').value = '';
        document.getElementById('account-error').textContent = '';
        
        // Set to create account mode by default
        setCreateAccountMode(true);
    }

    function setCreateAccountMode(isCreateMode) {
        isCreateAccountMode = isCreateMode;
        
        const title = document.getElementById('account-modal-title');
        const confirmPassInput = document.getElementById('account-confirm-password');
        const primaryBtn = document.getElementById('account-primary-btn');
        const switchBtn = document.getElementById('account-switch-btn');
        
        if (isCreateMode) {
            title.textContent = 'Create Account';
            confirmPassInput.style.display = 'block';
            primaryBtn.textContent = 'Create Account';
            switchBtn.textContent = 'Already have an account? Log In';
        } else {
            title.textContent = 'Log In';
            confirmPassInput.style.display = 'none';
            primaryBtn.textContent = 'Log In';
            switchBtn.textContent = 'Need an account? Create Account';
        }
    }

    // Toggle between create account and login modes
    document.getElementById('account-switch-btn').addEventListener('click', function() {
        setCreateAccountMode(!isCreateAccountMode);
        document.getElementById('account-error').textContent = '';
    });

    // Handle account creation/login
    document.getElementById('account-primary-btn').addEventListener('click', function() {
        const username = document.getElementById('account-username').value.trim();
        const password = document.getElementById('account-password').value;
        const confirmPassword = document.getElementById('account-confirm-password').value;
        const errorEl = document.getElementById('account-error');
        
        // Clear previous errors
        errorEl.textContent = '';
        
        // Validation
        if (!username) {
            errorEl.textContent = 'Please enter a username';
            return;
        }
        
        if (username.length < 3 || username.length > 20) {
            errorEl.textContent = 'Username must be 3-20 characters';
            return;
        }
        
        // Check for profanity in username
        if (containsProfanity(username)) {
            errorEl.textContent = 'Username contains inappropriate content';
            return;
        }
        
        // Sanitize username
        const sanitizedUsername = sanitizeUsername(username);
        if (sanitizedUsername !== username) {
            errorEl.textContent = 'Username contains invalid characters';
            return;
        }
        
        if (!password) {
            errorEl.textContent = 'Please enter a password';
            return;
        }
        
        if (password.length < 6) {
            errorEl.textContent = 'Password must be at least 6 characters';
            return;
        }
        
        if (isCreateAccountMode) {
            // Create account validation
            if (!confirmPassword) {
                errorEl.textContent = 'Please confirm your password';
                return;
            }
            
            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                return;
            }
            
            // Check if username already exists
            const existingUsers = JSON.parse(localStorage.getItem('cyberspaceUsers') || '{}');
            if (existingUsers[username.toLowerCase()]) {
                errorEl.textContent = 'Username already exists';
                return;
            }
            
            // Create new user
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const newUser = {
                id: userId,
                username: username,
                passwordHash: simpleHash(password), // In production, use proper password hashing
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                stats: {
                    totalRolls: 0,
                    illusionaryCount: 0,
                    bestRoll: null
                }
            };
            
            // Save user
            existingUsers[username.toLowerCase()] = newUser;
            localStorage.setItem('cyberspaceUsers', JSON.stringify(existingUsers));
            
            // Log in the new user
            loginUser(newUser);
            showTempNotification('Account created successfully!');
            
        } else {
            // Log in validation
            const existingUsers = JSON.parse(localStorage.getItem('cyberspaceUsers') || '{}');
            const userKey = username.toLowerCase();
            const user = existingUsers[userKey];
            
            if (!user) {
                errorEl.textContent = 'Username not found';
                return;
            }
            
            // Check password (in production, use proper password verification)
            if (user.passwordHash !== simpleHash(password)) {
                errorEl.textContent = 'Invalid password';
                return;
            }
            
            // Update last login
            user.lastLogin = new Date().toISOString();
            existingUsers[userKey] = user;
            localStorage.setItem('cyberspaceUsers', JSON.stringify(existingUsers));
            
            // Log in the user
            loginUser(user);
            showTempNotification('Logged in successfully!');
        }
        
        // Close modal
        hideAccountModal();
    });

    // Simple hash function for demo (in production, use proper bcrypt)
    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash.toString();
    }

    function loginUser(userData) {
        currentUser = {
            id: userData.id,
            username: userData.username,
            stats: userData.stats
        };
        isLoggedIn = true;
        
        // Save to localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('isLoggedIn', 'true');
        
        // Update UI
        updateAccountButton();
        updateUserDisplay();
    }

    function logout() {
        currentUser = null;
        isLoggedIn = false;
        
        // Clear from localStorage
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isLoggedIn');
        
        // Update UI
        updateAccountButton();
        updateUserDisplay();
        
        showTempNotification('Logged out');
    }

    function updateAccountButton() {
        const accountBtn = document.getElementById('account-button');
        const accountBtnText = document.getElementById('account-button-text');
        const accountIcon = document.getElementById('account-icon');
        
        if (isLoggedIn && currentUser) {
            // User is logged in - show "Logged in as (username)"
            accountBtnText.textContent = `Logged in as ${currentUser.username}`;
            accountIcon.textContent = 'âœ“';
            accountBtn.classList.add('logged-in');
            accountBtn.title = 'Click to log out';
        } else {
            // User is not logged in - show "Create Account / Log In"
            accountBtnText.textContent = 'Create Account / Log In';
            accountIcon.textContent = 'ðŸ‘¤';
            accountBtn.classList.remove('logged-in');
            accountBtn.title = 'Create account or log in';
        }
    }

    function updateUserDisplay() {
        const displayElement = document.getElementById('current-user-display');
        if (displayElement) {
            if (isLoggedIn && currentUser) {
                displayElement.textContent = `Logged in as ${currentUser.username}`;
            } else {
                displayElement.textContent = 'Not logged in';
            }
        }
    }

    // Load user from localStorage on page load
    function loadUserFromStorage() {
        const savedUser = localStorage.getItem('currentUser');
        const savedLoginState = localStorage.getItem('isLoggedIn');
        
        if (savedUser && savedLoginState === 'true') {
            currentUser = JSON.parse(savedUser);
            isLoggedIn = true;
            updateAccountButton();
            updateUserDisplay();
        }
    }

    // ============================================
    // LEADERBOARD FUNCTIONS (FIXED)
    // ============================================

    async function fetchLeaderboardData() {
        try {
            await new Promise(resolve => setTimeout(resolve, 500));

            // Check if we have any locally stored submissions
            const localSubmissions = JSON.parse(localStorage.getItem('cyberspaceSubmissions') || '[]');

            if (localSubmissions.length === 0) {
                leaderboardData = [];
                renderLeaderboard();
                return;
            }

            // Process submissions into leaderboard format
            const userMap = new Map();

            localSubmissions.forEach(submission => {
                if (!userMap.has(submission.userId)) {
                    userMap.set(submission.userId, {
                        username: submission.username,
                        bestRoll: submission.rolls,
                        totalHits: 1,
                        userId: submission.userId,
                        latestDate: submission.timestamp
                    });
                } else {
                    const userData = userMap.get(submission.userId);
                    if (submission.rolls < userData.bestRoll) {
                        userData.bestRoll = submission.rolls;
                    }
                    userData.totalHits++;
                    if (submission.timestamp > userData.latestDate) {
                        userData.latestDate = submission.timestamp;
                    }
                }
            });

            // Convert to array and sort by bestRoll (lowest first)
            leaderboardData = Array.from(userMap.values())
                .map((user, index) => ({
                    rank: index + 1,
                    name: user.username,
                    rolls: user.bestRoll,
                    hits: user.totalHits,
                    userId: user.userId,
                    date: user.latestDate.split('T')[0],
                    isCurrentUser: (currentUser && isLoggedIn && currentUser.id === user.userId)
                }))
                .sort((a, b) => a.rolls - b.rolls)
                .slice(0, 100);

            // Reassign ranks after sorting
            leaderboardData.forEach((entry, index) => {
                entry.rank = index + 1;
            });

            // FIX: Make sure we show ALL users on leaderboard, not just current user
            // This was the problem - we're already showing all users from userMap
            console.log('Leaderboard entries:', leaderboardData.length);
            console.log('Current user ID:', currentUser ? currentUser.id : 'none');
            
            renderLeaderboard();

        } catch (error) {
            console.error('Error fetching leaderboard:', error);
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="text-center py-20"><div class="text-red-400 text-lg mb-4">Error loading leaderboard</div><div class="text-white/50 text-sm">Please try again later</div></div>';
        }
    }

    function renderLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';

        if (leaderboardData.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'text-center py-20';
            emptyMessage.innerHTML = `
                <div class="text-cyan-400 text-lg mb-4">Leaderboard is empty</div>
                <div class="text-white/50 text-sm">
                    ${isLoggedIn ? 'Be the first to roll an illusionary!' : 'Create an account and roll an illusionary to appear here!'}
                </div>
            `;
            list.appendChild(emptyMessage);
            return;
        }

        leaderboardData.forEach(entry => {
            const entryElement = document.createElement('div');
            entryElement.className = 'leaderboard-entry';
            if (entry.isCurrentUser) {
                entryElement.style.borderColor = 'rgba(0, 242, 255, 0.6)';
                entryElement.style.background = 'rgba(0, 40, 80, 0.8)';
                entryElement.style.boxShadow = '0 0 15px rgba(0, 242, 255, 0.3)';
            }
            entryElement.innerHTML = `
                <div class="entry-rank">#${entry.rank}</div>
                <div class="entry-name">${entry.name} ${entry.isCurrentUser ? ' (You)' : ''}</div>
                <div class="entry-rolls">${entry.rolls.toLocaleString()}</div>
            `;
            list.appendChild(entryElement);
        });
    }

    function addLogEntry(hitIndex, rollAt) {
        logEntries.push({ index: hitIndex, roll: rollAt.toLocaleString() });
        if (logEntries.length > 4) logEntries.shift();
        rollLog.innerHTML = logEntries.map(entry => `<div class="log-entry">#${entry.index} illusionary at ${entry.roll} rolls.</div>`).join('');

        // If user is logged in, submit to leaderboard
        if (isLoggedIn && currentUser) {
            submitToLeaderboard(rollAt, hitIndex);
        }
    }

    function submitToLeaderboard(rolls, hitIndex) {
        // Save locally
        const leaderboardEntry = {
            userId: currentUser.id,
            username: currentUser.username,
            rolls: rolls,
            hitIndex: hitIndex,
            timestamp: new Date().toISOString()
        };

        let submissions = JSON.parse(localStorage.getItem('cyberspaceSubmissions') || '[]');
        submissions.push(leaderboardEntry);
        localStorage.setItem('cyberspaceSubmissions', JSON.stringify(submissions));

        console.log(`Leaderboard submission saved: ${currentUser.username} got illusionary #${hitIndex} at ${rolls} rolls`);
        
        // If leaderboard is open, refresh it
        if (document.getElementById('leaderboard-overlay').style.display === 'flex') {
            fetchLeaderboardData();
        }
    }

    // ============================================
    // CORE SIMULATOR FUNCTIONS
    // ============================================

    async function unlockMedia() {
        if (unlocked) return;
        bgm.volume = 0; bgm.play().then(() => { bgm.pause(); bgm.volume = bgmVolume; }).catch(() => {});
        illusionarySFX.volume = 0; illusionarySFX.play().then(() => { illusionarySFX.pause(); illusionarySFX.currentTime = 0; illusionarySFX.volume = sfxVolume; }).catch(() => {});
        video.removeAttribute('controls'); video.controls = false; video.muted = true; video.style.display = 'block';
        try { await video.play(); video.pause(); video.currentTime = 0; } catch (e) {}
        unlocked = true;
    }

    // Start simulator
    function startSimulator() {
        unlockMedia();
        document.getElementById('entry-overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('entry-overlay').style.display = 'none';
            bgm.play().catch(() => {});
        }, 500);
    }

    function showLeaderboard() {
        // Show loading state
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '<div class="text-center py-20"><div class="text-cyan-400 text-lg mb-4">Loading leaderboard...</div></div>';

        document.getElementById('leaderboard-overlay').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('leaderboard-overlay').style.opacity = '1';
            fetchLeaderboardData();
        }, 10);
    }

    function hideLeaderboard() {
        document.getElementById('leaderboard-overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('leaderboard-overlay').style.display = 'none';
        }, 500);
    }

    function returnToHomepage() {
        // Stop auto-rolling if active
        if (isAutoRolling) {
            toggleAutoRoll();
        }

        // Stop any active cinematic
        if (isCinematicPlaying) {
            skipCinematic();
        }

        // Reset the game state
        resetProgress();

        // Show the main entry overlay
        document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.add('ui-hidden'));

        setTimeout(() => {
            document.getElementById('entry-overlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('entry-overlay').style.opacity = '1';
                document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.remove('ui-hidden'));
                document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.style.display = 'none');
            }, 50);
        }, 300);

        // Pause BGM
        bgm.pause();
        bgm.currentTime = 0;
    }

    function toggleCinematicMode() {
        isCinematicEnabled = !isCinematicEnabled;
        const btn = document.getElementById('cinematic-toggle-btn'), status = document.getElementById('cine-status'), led = document.getElementById('cine-led');
        if (isCinematicEnabled) {
            btn.classList.add('active'); status.innerText = "On";
            status.classList.replace('text-white/40', 'text-green-400');
            led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
        } else {
            btn.classList.remove('active'); status.innerText = "Off";
            status.classList.replace('text-green-400', 'text-white/40');
            led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-slate-700 shadow-none";
        }
    }

    function skipCinematic() { if (isCinematicPlaying) { video.pause(); video.dispatchEvent(new Event('ended')); } }

    function triggerCinematic() {
        if (isCinematicPlaying) return;
        if (!isCinematicEnabled) { showIllusionaryTitle(); return; }
        isCinematicPlaying = true; bgm.pause();
        document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.add('ui-hidden'));
        cinematicOverlay.style.display = 'block';
        setTimeout(async () => {
            cinematicOverlay.style.opacity = '1'; video.muted = false; video.volume = sfxVolume; video.currentTime = 0;
            video.removeAttribute('controls'); video.controls = false;
            const checkProgress = () => {
                if (video.duration - video.currentTime <= 1.111 && video.duration > 0) {
                    showIllusionaryTitle(); video.removeEventListener('timeupdate', checkProgress);
                }
            };
            video.addEventListener('timeupdate', checkProgress);
            try { await video.play(); } catch (err) { video.onended(); }
        }, 50);
        video.onended = () => {
            cinematicOverlay.style.opacity = '0';
            setTimeout(() => {
                cinematicOverlay.style.display = 'none';
                document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.remove('ui-hidden'));
                bgm.play().catch(() => {}); isCinematicPlaying = false;
            }, 500);
        };
    }

    function clearDisplay() {
        const dw = document.getElementById('display-window'), oc = document.getElementById('odds-container');
        dw.classList.add('opacity-0', 'scale-95'); dw.classList.remove('opacity-100', 'scale-100');
        oc.classList.add('opacity-0'); oc.classList.remove('opacity-100');
        if (flickerInterval) { clearInterval(flickerInterval); flickerInterval = null; }
        isShowingIllusionary = false;
    }

    function showIllusionaryTitle() {
        const mainOutput = document.getElementById('main-output'), oddsContainer = document.getElementById('odds-container'), displayWindow = document.getElementById('display-window');
        isShowingIllusionary = true;
        mainOutput.innerHTML = "illusionary".split('').map(char => `<span class="flicker-char">${char}</span>`).join('');
        mainOutput.className = "text-3xl md:text-7xl illusionary-relic w-full";
        oddsContainer.classList.remove('opacity-0'); oddsContainer.classList.add('opacity-100');
        if (flickerInterval) clearInterval(flickerInterval);
        flickerInterval = setInterval(() => {
            const chars = mainOutput.querySelectorAll('.flicker-char');
            chars.forEach(c => c.classList.remove('flicker-white'));
            const rand = Math.floor(Math.random() * chars.length);
            if (chars[rand]) chars[rand].classList.add('flicker-white');
        }, 350);
        displayWindow.className = "opacity-100 transform scale-100 transition-all duration-300 w-full";
        illusionarySFX.currentTime = 0; illusionarySFX.volume = sfxVolume; illusionarySFX.play().catch(() => {});

        const flash = document.getElementById('flash');
        flash.classList.remove('glitch-flash', 'trans-flash');
        void flash.offsetWidth;
        flash.classList.add('glitch-flash');
    }

    function getHitCount(n, p) {
        if (n < 500) {
            let c = 0; for (let i = 0; i < n; i++) if (Math.random() < p) c++;
            return c;
        }
        const lambda = n * p;
        if (lambda < 30) {
            let L = Math.exp(-lambda), k = 0, p_val = 1;
            do { k++; p_val *= Math.random(); } while (p_val > L);
            return k - 1;
        }
        const stdDev = Math.sqrt(lambda);
        const u1 = Math.random(), u2 = Math.random();
        const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
        return Math.max(0, Math.floor(z0 * stdDev + lambda));
    }

    function runSim(count, potionType = null) {
        if (isCinematicPlaying && isCinematicEnabled) return;
        if (isShowingIllusionary) clearDisplay();

        if (count > 1) {
            const newHits = getHitCount(count, 1/ODDS);
            if (newHits > 0) {
                let hitRolls = [];
                for(let i=0; i<newHits; i++) hitRolls.push(rolls + Math.floor(Math.random() * count));
                hitRolls.sort((a,b) => a - b);

                hitRolls.forEach(rollAt => {
                    hits += 1;
                    addLogEntry(hits, rollAt);
                });

                rolls += count;
                document.getElementById('rolls-display').innerText = rolls.toLocaleString();
                document.getElementById('hits-display').innerText = hits.toLocaleString();
                triggerCinematic();
            } else {
                rolls += count;
                document.getElementById('rolls-display').innerText = rolls.toLocaleString();
                const flash = document.getElementById('flash');
                flash.classList.remove('glitch-flash', 'trans-flash');
                void flash.offsetWidth;
                flash.classList.add(potionType === 'trans' ? 'trans-flash' : 'glitch-flash');
            }
        } else {
            rolls += 1;
            document.getElementById('rolls-display').innerText = rolls.toLocaleString();
            if (Math.random() < 1/ODDS) {
                hits += 1;
                document.getElementById('hits-display').innerText = hits.toLocaleString();
                addLogEntry(hits, rolls);
                triggerCinematic();
            } else if (!isAutoRolling) {
                const flash = document.getElementById('flash');
                flash.classList.remove('glitch-flash', 'trans-flash');
                void flash.offsetWidth;
                flash.classList.add('glitch-flash');
            }
        }
    }

    function toggleAutoRoll() {
        isAutoRolling = !isAutoRolling;
        const btn = document.getElementById('auto-roll-btn'), status = document.getElementById('auto-status'), led = document.getElementById('auto-led');
        if (isAutoRolling) {
            btn.classList.add('active'); status.innerText = "Enabled";
            status.classList.replace('text-white/40', 'text-green-400');
            led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            autoRollInterval = setInterval(() => runSim(1), 50);
        } else {
            btn.classList.remove('active'); status.innerText = "Disabled";
            status.classList.replace('text-green-400', 'text-white/40');
            led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-slate-700 shadow-none";
            clearInterval(autoRollInterval);
        }
    }

    function handleCustomRoll() {
        let val = parseInt(document.getElementById('custom-roll-amount').value);
        if (!isNaN(val) && val > 0) runSim(Math.min(val, 150000000));
    }

    function updateSFXVolume(v) { sfxVolume = v/100; illusionarySFX.volume = sfxVolume; video.volume = sfxVolume; }
    function updateBGMVolume(v) { bgmVolume = v/100; bgm.volume = bgmVolume; }
    function resetProgress() {
        rolls = 0; hits = 0; if (isAutoRolling) toggleAutoRoll();
        logEntries = []; rollLog.innerHTML = '';
        document.getElementById('rolls-display').innerText = "0"; document.getElementById('hits-display').innerText = "0"; clearDisplay();
    }

    // Show a temporary notification
    function showTempNotification(message) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 20, 40, 0.9);
            color: #00f2ff;
            padding: 12px 24px;
            border-radius: 5px;
            border: 1px solid #00f2ff;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r') resetProgress(); });

    const container = document.getElementById('grid-container');
    setInterval(() => {
        if (document.hidden || isCinematicPlaying) return;
        const d = document.createElement('div');
        d.className = 'digit'; d.innerText = Math.round(Math.random());
        d.style.left = Math.random() * 100 + 'vw';
        container.appendChild(d);
        setTimeout(() => d.remove(), 4000);
    }, 150);

    window.addEventListener('mousedown', unlockMedia);
    window.addEventListener('touchstart', unlockMedia);

    // ============================================
    // INITIALIZATION
    // ============================================

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Cyberspace Luck Simulator initializing...');
        
        // Load saved user
        loadUserFromStorage();
        
        // Update UI
        updateAccountButton();
        updateUserDisplay();
        
        console.log('Initialization complete');
        console.log('Current user:', currentUser);
    });
</script>
